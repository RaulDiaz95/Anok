# Render Blueprint for Anok Platform
# This file defines all services for staging and production environments
#
# To use this blueprint:
# 1. Push this file to your repository
# 2. In Render dashboard, go to "Blueprints" and connect your repository
# 3. Render will automatically create all services defined below

databases:
  # Production Database
  - name: anok-db-prod
    databaseName: anok_db
    plan: starter  # Change to 'standard' for production workloads
    region: oregon  # Change to your preferred region
    ipAllowList: []  # Empty list allows all IPs

  # Staging Database
  - name: anok-db-staging
    databaseName: anok_db_staging
    plan: starter
    region: oregon
    ipAllowList: []

services:
  # ==========================================
  # PRODUCTION ENVIRONMENT
  # ==========================================

  # Production Backend API
  - type: web
    name: anok-api-prod
    runtime: docker
    region: oregon
    plan: starter  # Change to 'standard' for production
    branch: main  # Deploy from main branch
    dockerfilePath: ./backend/Dockerfile
    dockerContext: ./backend
    healthCheckPath: /api/actuator/health
    envVars:
      - key: SPRING_PROFILES_ACTIVE
        value: prod
      - key: PORT
        value: 8080
      - key: DB_HOST
        fromDatabase:
          name: anok-db-prod
          property: host
      - key: DB_PORT
        fromDatabase:
          name: anok-db-prod
          property: port
      - key: DB_NAME
        fromDatabase:
          name: anok-db-prod
          property: database
      - key: DB_USER
        fromDatabase:
          name: anok-db-prod
          property: user
      - key: DB_PASSWORD
        fromDatabase:
          name: anok-db-prod
          property: password
      - key: CORS_ALLOWED_ORIGINS
        value: https://anok-prod.onrender.com  # Update with your frontend URL
      - key: ENABLE_SWAGGER_UI
        value: false
      - key: ENABLE_API_DOCS
        value: false

  # Production Frontend
  - type: web
    name: anok-frontend-prod
    runtime: static
    region: oregon
    branch: main
    buildCommand: cd webapp && npm install && npm run build
    staticPublishPath: ./webapp/dist
    envVars:
      - key: VITE_API_URL
        value: https://anok-api-prod.onrender.com/api  # Update this after backend is deployed
    headers:
      - path: /*
        name: X-Frame-Options
        value: DENY
      - path: /*
        name: X-Content-Type-Options
        value: nosniff
      - path: /*
        name: X-XSS-Protection
        value: 1; mode=block
    routes:
      - type: rewrite
        source: /*
        destination: /index.html

  # ==========================================
  # STAGING ENVIRONMENT
  # ==========================================

  # Staging Backend API
  - type: web
    name: anok-api-staging
    runtime: docker
    region: oregon
    plan: starter
    branch: develop  # Deploy from develop branch (or use 'staging' if you have one)
    dockerfilePath: ./backend/Dockerfile
    dockerContext: ./backend
    healthCheckPath: /api/actuator/health
    envVars:
      - key: SPRING_PROFILES_ACTIVE
        value: prod
      - key: PORT
        value: 8080
      - key: DB_HOST
        fromDatabase:
          name: anok-db-staging
          property: host
      - key: DB_PORT
        fromDatabase:
          name: anok-db-staging
          property: port
      - key: DB_NAME
        fromDatabase:
          name: anok-db-staging
          property: database
      - key: DB_USER
        fromDatabase:
          name: anok-db-staging
          property: user
      - key: DB_PASSWORD
        fromDatabase:
          name: anok-db-staging
          property: password
      - key: CORS_ALLOWED_ORIGINS
        value: https://anok-staging.onrender.com  # Update with your staging frontend URL
      - key: ENABLE_SWAGGER_UI
        value: true  # Keep enabled in staging for testing
      - key: ENABLE_API_DOCS
        value: true

  # Staging Frontend
  - type: web
    name: anok-frontend-staging
    runtime: static
    region: oregon
    branch: develop
    buildCommand: cd webapp && npm install && npm run build
    staticPublishPath: ./webapp/dist
    envVars:
      - key: VITE_API_URL
        value: https://anok-api-staging.onrender.com/api
    routes:
      - type: rewrite
        source: /*
        destination: /index.html

# Notes:
# 1. Update service names and URLs to match your preferred naming
# 2. After first deployment, update CORS_ALLOWED_ORIGINS with actual frontend URLs
# 3. For custom domains, add them in Render dashboard and update URLs accordingly
# 4. Consider upgrading to 'standard' plan for production workloads
# 5. Adjust region based on your user base location
